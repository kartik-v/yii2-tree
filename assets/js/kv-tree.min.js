!function(a){"use strict";var b="kvtree",c={create:"create",createR:"create-root",trash:"remove",moveU:"move-up",moveD:"move-down",moveL:"move-left",moveR:"move-right",refresh:"refresh"},d=function(b,c){return null===b||void 0===b||0===b.length||c&&""===a.trim(b)},e=function(a){return a.replace(/[\-\[\]\/\{}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},f=function(a,b){a.removeClass(b).addClass(b)},g=function(a){return a.split("").reduce(function(a,b){return a=(a<<5)-a+b.charCodeAt(0),a&a},0)},h=function(){var a=0;return function(b,c){clearTimeout(a),a=setTimeout(b,c)}}(),i={timeout:3e5,data:{},remove:function(a){delete i.data[a]},exist:function(a){return!!i.data[a]&&(new Date).getTime()-i.data[a]._<i.timeout},get:function(a){return i.data[a].data},set:function(b,c,d){i.remove(b),i.data[b]={_:(new Date).getTime(),data:c},a.isFunction(d)&&d(c)}},j=function(b,c){var d=this;d.$element=a(b),d.init(c),d.listen()};j.prototype={constructor:j,init:function(b){var e,d=this;a.each(b,function(a,b){d[a]=b}),d.dialogLib=window[d.dialogLib]||"",d.btns=a.extend({},c,d.btns),d.$tree=a("#"+d.treeId),d.$treeContainer=d.$tree.parent(),d.$detail=a("#"+d.detailId),d.$toolbar=a("#"+d.toolbarId),d.$wrapper=a("#"+d.wrapperId),d.$searchContainer=d.$wrapper.find(".kv-search-container"),d.$search=d.$wrapper.find(".kv-search-input"),d.$clear=d.$wrapper.find(".kv-search-clear"),e=d.$detail.find("form"),d.treeManageHash=e.find('input[name="treeManageHash"]').val(),d.treeRemoveHash=e.find('input[name="treeRemoveHash"]').val(),d.treeMoveHash=e.find('input[name="treeMoveHash"]').val(),d.select(d.$element.data("key"),!0),i.timeout=d.cacheTimeout,d.hasActiveFilter=!1,d.selectNodes(),d.validateTooltips()},validateTooltips:function(){var a=this;a.showTooltips&&(a.$toolbar.find(".btn").tooltip(),a.$detail.find(".btn").tooltip())},trigAlert:function(b,c){var d=this.alertFadeDuration;c&&a.isFunction(c)||(c=function(){}),setTimeout(function(){b.fadeOut(d,c())},2*d)},selectNodes:function(){var b=this,c=b.$element.val();if(0!==c.length&&!d(c)){var e=b.$tree.find("li");e.removeClass("kv-selected"),c=c.split(","),a(c).each(function(a,c){f(b.$tree.find('li[data-key="'+c+'"]'),"kv-selected")})}},raise:function(a){var b=this;arguments.length>1?b.$element.trigger(a,arguments[1]):b.$element.trigger(a)},enableToolbar:function(){var a=this;a.$toolbar.find("button").removeAttr("disabled")},disableToolbar:function(){var a=this;a.$toolbar.find("button").attr("disabled",!0),a.$toolbar.find(".kv-"+a.btns.createR).removeAttr("disabled")},enable:function(a){var b=this;b.$toolbar.find(".kv-"+b.btns[a]).removeAttr("disabled")},disable:function(a){var b=this;b.$toolbar.find(".kv-"+b.btns[a]).attr("disabled",!0)},showAlert:function(a,b,c){var d=this,e=d.$detail,f=e.find(".alert-"+b);e.find(".kv-select-node-msg").remove(),f.removeClass("hide").hide().find("div").remove(),f.append("<div>"+a+"</div>").fadeIn(d.alertFadeDuration,function(){d.trigAlert(f,c)})},removeAlert:function(){var a=this;a.$detail.find(".alert").addClass("hide")},renderForm:function(c,e,h){var i=this,j=i.$detail,k=e||"",l=h||!1,m=g(c+i.modelClass+i.isAdmin+k),n=j.find("form"),o=i.actions.manage,p=o&&o.indexOf("?")!==-1?"&":"?";o+=encodeURI(p+b+"="+m),i.formViewBegin=!0,i.parseCache(),i.removeAlert(),a.ajax({type:"post",dataType:"json",data:{id:c,modelClass:i.modelClass,isAdmin:i.isAdmin,formAction:i.formAction,formOptions:i.formOptions,parentKey:k,iconsList:i.iconsList,currUrl:i.currUrl,softDelete:i.softDelete,showFormButtons:i.showFormButtons,showIDAttribute:i.showIDAttribute,multiple:i.multiple,nodeView:i.nodeView,nodeAddlViews:i.nodeAddlViews,nodeSelected:i.nodeSelected,breadcrumbs:i.breadcrumbs,allowNewRoots:i.allowNewRoots,treeManageHash:i.treeManageHash},url:o,cache:!0,beforeSend:function(a,b){i.raise("treeview.beforeselect",[c,a,b]),n.length&&n.off().yiiActiveForm("destroy").remove(),j.html(""),f(j,"kv-loading")},success:function(a,b,e){return j.removeClass("kv-loading"),"error"===a.status?(j.html('<div class="alert alert-danger" style="margin-top:20px">'+a.out+"</div>"),void i.raise("treeview.selecterror",[c,a,b,e])):(j.html(a.out),j.find('button[type="reset"]').on("click",function(){i.removeAlert()}),i.removeAlert(),l===!1||d(l.out)||i.showAlert(l.out,l.type),void i.raise("treeview.selected",[c,a,b,e]))},error:function(a,b,d){i.raise("treeview.selectajaxerror",[c,a,b,d])},complete:function(a){i.validateTooltips(),i.raise("treeview.selectajaxcomplete",[c,a])}})},select:function(b,c,e){if(!d(b)){var h,g=this,i=c||!1,j=e||!1,k=g.$tree.find('li[data-key="'+b+'"]>.kv-tree-list .kv-node-detail');0!==k.length&&(g.$tree.find(".kv-node-detail").removeClass("kv-focussed"),f(k,"kv-focussed"),i?g.$tree.find("li.kv-parent").each(function(){var b=a(this);b.has(k).length>0&&b.removeClass("kv-collapsed")}):g.renderForm(b,null,j),h=k.closest("li"),h.hasClass("kv-disabled")?g.disableToolbar():g.enableToolbar(),(!h.data("removable")||h.hasClass("kv-inactive")&&g.softDelete||!h.data("removableAll")&&h.hasClass("kv-parent"))&&g.disable("trash"),h.data("movable-u")||g.disable("moveU"),h.data("movable-d")||g.disable("moveD"),h.data("movable-l")||g.disable("moveL"),h.data("movable-r")||g.disable("moveR"),g.parseParentFlag(b))}},parseParentFlag:function(b){var e,c=this,d=c.$detail.find('input[class="kv-parent-flag"]'),f=c.$tree.find('li[data-key="'+b+'"]');d.each(function(){var b=a(this);e=b.closest("div.checkbox"),e.removeClass("disabled"),f.hasClass("kv-parent")?b.removeAttr("disabled"):(b.attr("disabled","disabled"),e.addClass("disabled"))})},remove:function(){var i,j,b=this,c=b.$tree.find("li .kv-node-detail.kv-focussed"),d=c.closest("li"),e=b.messages,g=b.$detail,h=g.find("form");0===c.length&&!d.hasClass("kv-empty")||d.hasClass("kv-disabled")||b.dialogLib.confirm(e.removeNode,function(c){if(c){if(j=function(a){var c=a?e.emptyNodeRemoved:e.nodeRemoved,f=d.closest("li.kv-parent");d.remove(),i=g.find(".alert"),b.formViewBegin=!1,g.find(".kv-select-node-msg").remove(),i.length&&g.before(i).html("").append(i),f.find("li").length||f.removeClass("kv-parent"),b.showAlert(c,"info",function(){g.append('<h4 class="alert text-center kv-select-node-msg" style="display:none;">'+e.selectNode+"</h4>"),setTimeout(function(){b.formViewBegin||g.find(".kv-select-node-msg").fadeIn(b.alertFadeDuration)},b.alertFadeDuration)})},d.hasClass("kv-empty"))return void j(!0);var k=d.data("key");a.ajax({type:"post",dataType:"json",data:{id:k,modelClass:b.modelClass,softDelete:b.softDelete,treeRemoveHash:b.treeRemoveHash},url:b.actions.remove,beforeSend:function(a,c){b.raise("treeview.beforeremove",[k,a,c]),h.hide(),b.removeAlert(),f(g,"kv-loading")},success:function(a,c,e){if("success"===a.status){if((b.isAdmin||b.showInactive)&&b.softDelete){b.showAlert(a.out,"info"),h.show();var i=b.modelClass.split("\\").pop(),l=h.find('input[name="'+i+'[active]"]');l.val(!1),l.prop("checked",!1),f(d,"kv-inactive"),d.data("removableAll")&&f(d.find("li"),"kv-inactive"),f(d,"kv-inactive")}else j();b.softDelete||b.disableToolbar(),b.raise("treeview.remove",[k,a,c,e])}else b.showAlert(a.out,"danger"),h.show(),b.raise("treeview.removeerror",[k,a,c,e]);g.removeClass("kv-loading")},error:function(a,c,d){b.raise("treeview.removeajaxerror",[k,a,c,d])},complete:function(a){b.raise("treeview.removeajaxcomplete",[a])}})}})},move:function(b){var k,l,m,o,c=this,d=c.$tree.find("li .kv-node-detail.kv-focussed"),e=d.closest("li"),g=c.messages,h=c.$detail,j=null,n=!1,p=function(){};if(0!==d.length&&!e.hasClass("kv-disabled")){if(e.hasClass("kv-empty"))return void c.dialogLib.alert(g.nodeNewMove);switch(b){case"u":if(j=e.prev(),0===j.length)return void c.dialogLib.alert(g.nodeTop);p=function(){j.before(e)};break;case"d":if(j=e.next(),0===j.length)return void c.dialogLib.alert(g.nodeBottom);p=function(){j.after(e)};break;case"l":if(j=e.parent("ul").closest("li.kv-parent"),0===j.length)return void c.dialogLib.alert(g.nodeLeft);o=j.parent("ul"),n=o.hasClass("kv-tree"),n&&(j=o.children("li:last-child")),p=function(){j.after(e),0===j.find("li").length&&(j.removeClass("kv-parent"),j.find("ul").remove())};break;case"r":if(j=e.prev(),0===j.length)return void c.dialogLib.alert(g.nodeRight);p=function(){j.find("li").length>0?j.children("ul").append(e):(f(j,"kv-parent"),a(document.createElement("ul")).appendTo(j).append(e))};break;default:throw"Invalid move direction '"+b+"'"}k=e.data("key"),l=j.data("key"),a.ajax({type:"post",dataType:"json",data:{idFrom:k,idTo:l,modelClass:c.modelClass,dir:b,allowNewRoots:c.allowNewRoots,treeMoveHash:c.treeMoveHash},url:c.actions.move,beforeSend:function(a,d){c.raise("treeview.beforemove",[b,k,l,a,d]),f(c.$treeContainer,"kv-loading-search")},success:function(d,f,g){h.length>0&&c.removeAlert(),"success"===d.status?(p(),"l"===b||"r"===b?(i.timeout=0,m=h.length>0&&{out:d.out,type:"success"},c.select(k,!1,m),i.timeout=c.cacheTimeout):h.length>0&&c.showAlert(d.out,"success"),c.$tree.find("li.kv-collapsed").each(function(){a(this).has(e).length>0&&a(this).removeClass("kv-collapsed")}),c.raise("treeview.move",[b,k,l,d,f,g])):h.length>0&&(c.showAlert(d.out,"danger"),c.raise("treeview.moveerror",[b,k,l,d,f,g])),c.$treeContainer.removeClass("kv-loading-search")},error:function(a,d,e){h.length>0&&(c.removeAlert(),c.showAlert(e,"danger")),c.$treeContainer.removeClass("kv-loading-search"),c.raise("treeview.moveajaxerror",[b,k,l,a,d,e])},complete:function(a){c.raise("treeview.moveajaxcomplete",[a])}})}},setSelected:function(){var b=this,c="",e="";b.$tree.find(".kv-selected").each(function(){var b=a(this),f=d(c)?"":",";c+=f+b.data("key"),e+=f+b.find(">.kv-tree-list .kv-node-label").text()}),b.$element.val(c),b.raise("treeview.change",[c,e]),b.raise("change")},getNewNode:function(){var a=this;return'<div class="kv-tree-list" tabindex="-1">\n   <div class="kv-node-indicators">&nbsp;</div>\n   <div class="kv-node-detail kv-focussed">\n       <span class="kv-node-label">'+a.messages.emptyNode+"</span>\n   </div>\n</div>"},create:function(){var d,e,i,j,k,b=this,c=b.$tree.find("li .kv-node-detail.kv-focussed"),g=c.closest("li"),h=b.messages;return g.hasClass("kv-disabled")?void b.dialogLib.alert(h.nodeDisabled):0===c.length||g.hasClass("kv-empty")?void b.dialogLib.alert(h.invalidCreateNode):(b.$toolbar.find(".kv-"+b.btns.trash).removeAttr("disabled"),k=g.find("> ul > li.kv-empty"),k.length>0?(e=k.data("key").replace("empty-",""),b.renderForm(null,e),c.removeClass("kv-focussed"),void f(k.find(".kv-node-detail"),"kv-focussed")):(k=a(document.createElement("li")).attr({"data-key":"empty-"+g.data("key"),class:"kv-empty"}),i=b.getNewNode(),c.removeClass("kv-focussed"),k.append(i),g.hasClass("kv-parent")?g.children("ul").append(k):(f(g,"kv-parent"),d=a(document.createElement("ul")).append(k),g.append(d)),b.renderForm(null,g.data("key")),j=k.find(".kv-node-detail"),g.removeClass("kv-collapsed"),k.children(".kv-tree-list").focus(),j.on("click",function(){b.$tree.find(".kv-node-detail").removeClass("kv-focussed"),f(j,"kv-focussed"),e=k.data("key").replace("empty-",""),b.renderForm(null,e),b.$toolbar.find(".kv-"+b.btns.trash).removeAttr("disabled")}),void b.raise("treeview.create",[parent])))},createRoot:function(){var b=this,c=b.$tree.find(".kv-tree"),d=c.children("li.kv-empty");if(b.$tree.find(".kv-node-detail").removeClass("kv-focussed"),d.length>0)return f(d.find(".kv-node-detail"),"kv-focussed"),void b.renderForm(null,b.rootKey);var e=b.getNewNode(),g=a(document.createElement("li")).attr({"data-key":"empty-root",class:"kv-empty"});g.html(e),c.append(g),b.renderForm(null,b.rootKey);var h=g.find(".kv-node-detail");f(h,"kv-focussed"),b.$toolbar.find(".kv-"+b.btns.trash).removeAttr("disabled"),h.on("click",function(){b.$tree.find(".kv-node-detail").removeClass("kv-focussed"),f(h,"kv-focussed"),b.renderForm(null,b.rootKey),b.$toolbar.find(".kv-"+b.btns.trash).removeAttr("disabled")}),b.raise("treeview.createroot")},toggle:function(a){var b=this,c=a.closest("li.kv-parent"),d=c.data("key");c.hasClass("kv-collapsed")?(c.removeClass("kv-collapsed"),b.raise("treeview.expand",[d])):(f(c,"kv-collapsed"),b.raise("treeview.collapse",[d]))},toggleAll:function(a,b){var c=this;return"expand"===a?(c.$tree.removeClass("kv-collapsed"),c.$tree.find(".kv-collapsed").removeClass("kv-collapsed"),void(b&&c.raise("treeview.expandall"))):(f(c.$tree.find("li.kv-parent"),"kv-collapsed"),f(c.$tree,"kv-collapsed"),void(b&&c.raise("treeview.collapseall")))},check:function(a){var d,b=this,c=a===!0,e=c?b.$tree:a.closest("li"),g=c?"":e.data("key"),h=b.multiple&&0!=b.multiple;e.hasClass("kv-disabled")||c&&!h||(e.hasClass("kv-selected")?(e.removeClass("kv-selected"),h?b.cascadeSelectChildren&&e.find("li:not(.kv-disabled)").removeClass("kv-selected"):(b.$tree.find("li:not(.kv-disabled)").removeClass("kv-selected"),b.$element.val(""),b.raise("treeview.change",["",""]),b.raise("change")),b.raise("treeview.unchecked",[g])):(h?b.cascadeSelectChildren&&f(e.find("li:not(.kv-disabled)"),"kv-selected"):(b.$tree.find("li:not(.kv-disabled)").removeClass("kv-selected"),b.$element.val(g),d=e.find(">.kv-tree-list .kv-node-label").text(),b.raise("treeview.change",[g,d]),b.raise("change")),f(e,"kv-selected"),b.raise("treeview.checked",[g])),h&&b.setSelected())},clear:function(){var a=this;a.$treeContainer.removeClass("kv-loading-search"),a.$tree.find(".kv-highlight").removeClass("kv-highlight")},parseCache:function(){var b=this;return!!b.enableCache&&void a.ajaxPrefilter(function(b,c){if(b.cache){var d=c.beforeSend||a.noop,e=c.success||a.noop,f=c.url;b.cache=!1,b.beforeSend=function(){return d(),!i.exist(f)||(e(i.get(f)),!1)},b.success=function(a){i.set(f,a,e)}}})},focusActiveFilter:function(){var a=this;a.hasActiveFilter||(a.hasActiveFilter=!0),a.$search.val().length>0&&f(a.$treeContainer,"kv-active-filter")},blurActiveFilter:function(){var b=this,c=a(this),d=c.closest(".kv-tree-container");b.hasActiveFilter&&(b.hasActiveFilter=!1),b.$treeContainer.removeClass("kv-active-filter"),b.$tree.find(".kv-highlight").removeClass("kv-highlight"),d.find("li.kv-filter-match").removeClass("kv-filter-match")},listen:function(){var b=this;b.$tree.find(".kv-node-toggle").each(function(){a(this).on("click",function(){b.toggle(a(this))})}),b.$tree.find(".kv-node-checkbox:not(.kv-disabled)").each(function(){a(this).on("click",function(){b.check(a(this))})}),b.$treeContainer.find(".kv-root-node-toggle").on("click",function(){var c=a(this),d=c.closest(".kv-tree-container");d.hasClass("kv-collapsed")?b.toggleAll("expand",!0):b.toggleAll("collapse",!0)}),b.$treeContainer.find(".kv-root-node-checkbox").on("click",function(){b.check(!0)}),b.$search.on("keyup",function(){var c=a(this).val();return b.clear(),0===c.length?void b.blurActiveFilter():(b.focusActiveFilter(),f(b.$treeContainer,"kv-loading-search"),void h(function(){b.$tree.find("li.kv-filter-match").removeClass("kv-filter-match"),b.toggleAll("collapse",!1),c=e(c),b.$tree.find(".kv-node-label").each(function(){var d=a(this),e=d.text(),g=e.search(new RegExp(c,"i"));g<0?d.removeClass("kv-highlight"):(f(d,"kv-highlight"),b.$tree.find("li.kv-parent").each(function(){var b=a(this);b.has(d).length>0&&b.removeClass("kv-collapsed")}))}),b.$tree.find(".kv-highlight").parentsUntil(b.$tree.selector,"li").each(function(){f(a(this),"kv-filter-match")}),b.$treeContainer.removeClass("kv-loading-search"),b.raise("treeview.search")},1500))}).focus(function(){b.focusActiveFilter()}).blur(function(){""==a(this).val()&&b.blurActiveFilter()}),b.$clear.on("click",function(){b.$search.val(""),b.clear(),b.blurActiveFilter()}),b.$tree.find(".kv-node-detail").each(function(){a(this).on("click",function(){var c=a(this),d=c.closest("li"),e=d.data("key");return b.$tree.hasClass("kv-tree-input-widget")?(c.removeClass("kv-focussed"),void b.check(d)):void(c.hasClass("kv-focussed")||(b.select(e),b.removeAlert(),b.raise("treeview.select",[e])))})}),b.$toolbar.find(".kv-"+b.btns.create).on("click",function(){b.create()}),b.$toolbar.find(".kv-"+b.btns.createR).on("click",function(){b.createRoot()}),b.$toolbar.find(".kv-"+b.btns.trash).on("click",function(){b.remove()}),b.$toolbar.find(".kv-"+b.btns.moveU).on("click",function(){b.move("u")}),b.$toolbar.find(".kv-"+b.btns.moveD).on("click",function(){b.move("d")}),b.$toolbar.find(".kv-"+b.btns.moveL).on("click",function(){b.move("l")}),b.$toolbar.find(".kv-"+b.btns.moveR).on("click",function(){b.move("r")}),b.$detail.find(".alert").each(function(){var c=a(this);c.hasClass("hide")||(c.hide().fadeIn(1500),b.trigAlert(c))})},expandAll:function(){this.toggleAll("expand")},collapseAll:function(){this.toggleAll("collapse")},checkAll:function(){var a=this;a.$tree.removeClass("kv-selected"),a.check(!0)},uncheckAll:function(){var a=this;f(a.$tree,"kv-selected"),a.check(!0)},checkNode:function(a){var b=this,c=b.$tree.find('li[data-key="'+a+'"]');c.length&&(c.removeClass("kv-selected"),b.check(c))},uncheckNode:function(a){var b=this,c=b.$tree.find('li[data-key="'+a+'"]');c.length&&(f(c,"kv-selected"),b.check(c))}},a.fn.treeview=function(b){var d,e,f,c=Array.apply(null,arguments);return c.shift(),this.each(function(){d=a(this),e=d.data("treeview"),f="object"==typeof b&&b,e||(e=new j(this,a.extend({},a.fn.treeview.defaults,f,a(this).data())),d.data("treeview",e)),"string"==typeof b&&e[b].apply(e,c)})},a.fn.treeview.defaults={btns:{},treeId:"",detailId:"",toolbarId:"",wrapperId:"",showTooltips:!0,alertFadeDuration:1e3,cacheTimeout:3e5,showInactive:!1,actions:{manage:"",move:"",delete:""},messages:{emptyNode:"",nodeDisabled:"",invalidCreateNode:"",removeNode:"",nodeRemoved:"",emptyNodeRemoved:"",nodeNewMove:"",nodeTop:"",nodeBottom:"",nodeLeft:"",nodeRight:""},breadcrumbs:{},cascadeSelectChildren:!0,rootKey:""},a.fn.treeview.Constructor=j}(window.jQuery);